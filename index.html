<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
</head>
<body>
    <nav>
        <button class="create">
            <div class="rect">
                <div class="rect1"></div>
                <div class="rect2"></div>
            </div>
        </button>
    </nav>
    <main>
        <div class="chat">
            <div class="loader" id="loading" style="display: none;"></div> <!-- Zone d'affichage des réponses de l'IA -->
        </div>
        <div class="sub">
            <textarea class="search" id="userInput" rows="6" cols="35" placeholder="Rechercher une personne..."></textarea><br>
            <button class="subbutton" id="sendButton" onclick="handleSendButtonClick()">
                <img src="envoyer.png" class="icon_submit">
                <div class="text_submit">Envoyer</div>
            </button>
        </div>
    </main>
    <script>
        const sessionId = 'session_' + Date.now();
        const ws = new WebSocket('ws://localhost:8765');
        const chatDiv = document.querySelector('.chat');
        let shouldScroll; // Sélection du conteneur de chat

        document.getElementById('userInput').addEventListener('keydown', function(event) {
            if (event.key === 'Enter') {
                event.preventDefault(); // Empêcher la création d'une nouvelle ligne dans le champ de saisie
                handleSendButtonClick(); // Appeler la fonction d'envoi du message
            }
        });

        ws.onopen = function() {
            ws.send(sessionId);
        };

        ws.onmessage = function(event) {
            const responseElement = document.querySelector('.response.loading'); // Trouver l'élément de réponse avec loading
            parseAndDisplayTable(event.data, responseElement); // Utiliser la fonction de parsing pour afficher le tableau ou le texte
            responseElement.classList.remove('loading');
            if (shouldScroll) {
                chatDiv.scrollTop = chatDiv.scrollHeight;
            }
        };

        function handleSendButtonClick() {
            const userInput = document.getElementById('userInput');
            if (userInput.value.trim() !== '') {
                shouldScroll = chatDiv.scrollHeight - chatDiv.clientHeight <= chatDiv.scrollTop + 60; // Était près du bas
                createMessageElement(userInput.value, 'user'); // Créer un élément pour le message utilisateur
                const responseElement = createMessageElement('', 'response loading'); // Préparer l'espace pour la réponse de l'IA
                addLoadingSpinner(responseElement); // Ajouter l'animation de chargement dans l'espace de la réponse
                ws.send(userInput.value);
                userInput.value = ''; // Effacer la zone de texte après l'envoi

                if (shouldScroll) {
                    chatDiv.scrollTop = chatDiv.scrollHeight; // Faire défiler vers le bas
                }
            }
        }

        function createMessageElement(text, type) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message');
            messageDiv.textContent = text;

            if (type.includes('response')) {
                messageDiv.classList.add('response');
            } else {
                messageDiv.classList.add('user');
            }

            if (type.includes('loading')) {
                messageDiv.classList.add('loading'); // Indique que cet élément est en chargement
            }

            chatDiv.appendChild(messageDiv);
            return messageDiv;
        }

        function addLoadingSpinner(element) {
            const loaderDiv = document.createElement('div');
            loaderDiv.className = 'loader';
            element.appendChild(loaderDiv); // Ajouter l'animation de chargement à l'élément spécifié
        }

        function parseAndDisplayTable(responseText, element) {
            if (responseText.includes('asc[') && responseText.includes('data[')) {
                // Parse et affiche le tableau si les balises spécifiques sont trouvées
                const lines = responseText.split(']');
                const table = document.createElement('table');
                table.border = '1';

                lines.forEach(line => {
                    if (line.trim().length === 0) {
                        return; // Ignorer les lignes vides
                    }
                    const parts = line.split('[');
                    if (parts.length < 2) {
                        return; // Ignorer les lignes mal formatées
                    }
                    const type = parts[0].trim(); // 'asc' ou 'data'
                    const content = parts[1];
                    const cells = content.split('|');

                    const row = table.insertRow();
                    cells.forEach(cell => {
                        const cellContent = cell.trim();
                        if (cellContent.length > 0) {
                            const cellElement = (type === 'asc' ? row.insertCell() : row.insertCell());
                            cellElement.textContent = cellContent;
                            if (type === 'asc') {
                                cellElement.style.fontWeight = 'bold';
                            }
                        }
                    });
                });

                element.textContent = ''; // Effacer le texte existant ou l'animation de chargement
                element.appendChild(table); // Ajouter le tableau à l'élément
            } else {
                // Affiche simplement le texte si aucun indicateur de tableau n'est présent
                element.textContent = responseText;
            }
        }
    </script>
</body>
</html>

